# üìä Metadata Schema Documentation

## Overview
The `metadata` schema stores system tracking data for the analytics platform.

---

## üìÅ Schema Structure

```
analytics-llm
‚îú‚îÄ‚îÄ public (Data Tables)
‚îÇ   ‚îú‚îÄ‚îÄ crm_customers
‚îÇ   ‚îú‚îÄ‚îÄ erp_purchase_orders
‚îÇ   ‚îú‚îÄ‚îÄ multivendor_orders
‚îÇ   ‚îî‚îÄ‚îÄ social_media_analytics
‚îÇ
‚îî‚îÄ‚îÄ metadata (System Tables)
    ‚îú‚îÄ‚îÄ generated_reports
    ‚îú‚îÄ‚îÄ user_activity_logs
    ‚îú‚îÄ‚îÄ query_matching_logs
    ‚îî‚îÄ‚îÄ admin_report_requests
```

---

## üìã Table Details

### 1. `generated_reports` (18 columns)
**Purpose:** Track all reports generated by users

**Key Columns:**
- `report_id` (PK) - Unique report identifier
- `report_name` - Name of the report
- `report_type` - Type/category of report
- `user_id` / `user_email` - User who generated it
- `query_text` - Original user query
- `data_source` / `table_name` - Source data
- `columns_used` - Array of columns used
- `row_count` - Number of rows in result
- `execution_time_ms` - Processing time
- `status` - completed/failed/processing
- `created_at` / `completed_at` - Timestamps

**Use Cases:**
- Report history and audit trail
- User reporting patterns analysis
- Performance monitoring
- Popular report identification

---

### 2. `user_activity_logs` (19 columns)
**Purpose:** Track all user actions and behavior

**Key Columns:**
- `activity_id` (PK) - Unique activity identifier
- `user_id` / `user_email` - User information
- `session_id` - Session tracking
- `activity_type` - Type of activity
- `activity_description` - Details
- `page_url` / `action` - Where and what
- `ip_address` / `user_agent` - Client info
- `device_type` / `browser` - Device info
- `duration_seconds` - Time spent
- `success` - Whether action succeeded
- `timestamp` - When it happened

**Use Cases:**
- User behavior analysis
- Session tracking
- Error tracking
- Usage patterns
- Security auditing

---

### 3. `query_matching_logs` (26 columns)
**Purpose:** Track query matching - both successful and failed attempts

**Key Columns:**
- `query_log_id` (PK) - Unique log identifier
- `user_query` - Original natural language query
- `query_intent` - Interpreted intent
- `required_columns` - Columns needed
- `optional_columns` - Nice-to-have columns
- `matched_table` - Which table was matched
- `match_status` - matched/not_matched/partial
- `match_confidence` - Confidence score (0-100)
- `missing_columns` - What columns are missing
- `alternative_suggestions` - Suggestions for user
- `llm_model` - Which LLM was used
- `llm_tokens_used` - Token consumption
- `processing_time_ms` - Processing time
- `sql_generated` - Generated SQL query
- `success` - Overall success status

**Use Cases:**
- Query matching performance
- Identify data gaps (missing columns)
- Improve LLM prompts
- User query patterns
- Generate training data

---

### 4. `admin_report_requests` (27 columns)
**Purpose:** New report requests from users for admin approval

**Key Columns:**
- `request_id` (PK) - Unique request identifier
- `requester_user_id` / `requester_email` - Who requested
- `request_title` - Short title
- `request_description` - Detailed description
- `business_justification` - Why it's needed
- `required_data_sources` - What data is needed
- `required_columns` - Specific columns
- `priority` - critical/high/medium/low
- `status` - pending/approved/rejected/completed
- `assigned_to` - Admin assigned
- `admin_notes` / `approval_notes` - Admin feedback
- `created_at` / `approved_at` / `completed_at` - Timestamps

**Use Cases:**
- Feature request tracking
- Prioritize development work
- User needs analysis
- Approval workflow
- Effort estimation

---

## üîç Common Queries

### Get Report Statistics
```sql
SELECT 
    DATE(created_at) as date,
    COUNT(*) as total_reports,
    AVG(execution_time_ms) as avg_time_ms
FROM metadata.generated_reports
WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

### Find Most Active Users
```sql
SELECT 
    user_email,
    COUNT(*) as activity_count,
    MAX(timestamp) as last_active
FROM metadata.user_activity_logs
WHERE timestamp >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY user_email
ORDER BY activity_count DESC
LIMIT 10;
```

### Query Match Success Rate
```sql
SELECT 
    match_status,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) as percentage
FROM metadata.query_matching_logs
WHERE created_at >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY match_status;
```

### Pending Admin Requests
```sql
SELECT 
    request_title,
    requester_email,
    priority,
    created_at
FROM metadata.admin_report_requests
WHERE status = 'pending'
ORDER BY 
    CASE priority
        WHEN 'critical' THEN 1
        WHEN 'high' THEN 2
        WHEN 'medium' THEN 3
        WHEN 'low' THEN 4
    END,
    created_at;
```

---

## üìà Analytics Dashboard Queries

### System Health Dashboard
```sql
-- Last 24 hours metrics
WITH metrics AS (
    SELECT 
        COUNT(DISTINCT r.user_id) as active_users,
        COUNT(r.report_id) as reports_generated,
        COUNT(q.query_log_id) as queries_made,
        COUNT(q.query_log_id) FILTER (WHERE q.match_status = 'matched') as successful_queries,
        AVG(r.execution_time_ms) as avg_execution_time
    FROM metadata.generated_reports r
    FULL JOIN metadata.query_matching_logs q 
        ON DATE(r.created_at) = DATE(q.created_at)
    WHERE r.created_at >= CURRENT_TIMESTAMP - INTERVAL '24 hours'
       OR q.created_at >= CURRENT_TIMESTAMP - INTERVAL '24 hours'
)
SELECT * FROM metrics;
```

### User Engagement Report
```sql
SELECT 
    u.user_email,
    COUNT(DISTINCT DATE(u.timestamp)) as active_days,
    COUNT(u.activity_id) as total_activities,
    COUNT(r.report_id) as reports_generated,
    COUNT(q.query_log_id) as queries_made
FROM metadata.user_activity_logs u
LEFT JOIN metadata.generated_reports r ON u.user_email = r.user_email
LEFT JOIN metadata.query_matching_logs q ON u.user_id = q.user_id
WHERE u.timestamp >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY u.user_email
ORDER BY active_days DESC, total_activities DESC;
```

---

## üîê Indexes Created

### generated_reports
- `idx_generated_reports_user_id` - Query by user
- `idx_generated_reports_created_at` - Time-based queries
- `idx_generated_reports_status` - Filter by status

### user_activity_logs
- `idx_user_activity_user_id` - Query by user
- `idx_user_activity_timestamp` - Time-based queries
- `idx_user_activity_type` - Filter by activity type
- `idx_user_activity_session` - Session tracking

### query_matching_logs
- `idx_query_matching_user_id` - Query by user
- `idx_query_matching_status` - Filter by match status
- `idx_query_matching_created_at` - Time-based queries
- `idx_query_matching_matched_table` - Filter by table

### admin_report_requests
- `idx_admin_requests_requester` - Query by requester
- `idx_admin_requests_status` - Filter by status
- `idx_admin_requests_priority` - Filter by priority
- `idx_admin_requests_created_at` - Time-based queries
- `idx_admin_requests_assigned_to` - Filter by assignee

---

## üí° Best Practices

### When to Log

**generated_reports:**
- Log every report generation attempt
- Include both successful and failed attempts

**user_activity_logs:**
- Log all significant user actions
- Page views, button clicks, form submissions
- Login/logout events

**query_matching_logs:**
- Log every query attempt (matched or not)
- Critical for improving matching algorithm

**admin_report_requests:**
- User submits feature request
- Admin reviews/approves/rejects
- Development completes implementation

### Data Retention

Consider implementing data retention policies:
- Keep detailed logs for 90 days
- Archive older data (summarized)
- Critical audit data: keep longer

---

## üîÑ Next Steps

1. **Refresh DBeaver** to see the new tables
2. **Review example queries** in `METADATA_TABLES_EXAMPLES.sql`
3. **Integrate logging** into your application
4. **Build dashboards** using this data

---

## üìû Need More?

Additional tables you might want:
- `api_usage_logs` - API endpoint usage
- `data_quality_logs` - Data quality checks
- `scheduled_reports` - Scheduled report configurations
- `alert_history` - System alerts and notifications

